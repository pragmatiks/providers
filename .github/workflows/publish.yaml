name: Publish Providers

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      providers: ${{ steps.changes.outputs.providers }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed providers
        id: changes
        run: |
          # Get changed files since last provider tag or last commit
          # Look for any provider tag (gcp-v*, aws-v*, etc.)
          LAST_TAG=$(git tag -l "*-v*" --sort=-version:refname | head -1 || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGED_FILES=$(git diff --name-only "$LAST_TAG"..HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git ls-files)
          fi

          # Extract unique provider directories that changed
          PROVIDERS=$(echo "$CHANGED_FILES" | grep "^packages/" | cut -d/ -f2 | sort -u | tr '\n' ' ')

          if [ -n "$PROVIDERS" ]; then
            echo "providers=$PROVIDERS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed providers: $PROVIDERS"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No provider changes detected"
          fi

  bump-and-publish:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.x"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install commitizen
        run: uv tool install commitizen

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump and build changed providers
        id: bump
        run: |
          BUILT_PACKAGES=""
          VERSIONS=""

          for provider in ${{ needs.detect-changes.outputs.providers }}; do
            echo "::group::Processing $provider"
            cd packages/$provider

            # Try to bump version based on conventional commits
            if cz bump --yes --changelog 2>&1 | tee bump_output.txt; then
              VERSION=$(cz version --project)
              echo "Bumped $provider to v$VERSION"
              VERSIONS="$VERSIONS $provider:$VERSION"

              # Build the package
              uv build
              BUILT_PACKAGES="$BUILT_PACKAGES packages/$provider/dist/*"
            else
              if grep -qE "No commits found|is not a bump" bump_output.txt; then
                echo "No bump needed for $provider"
              else
                cat bump_output.txt
                exit 1
              fi
            fi

            cd ../..
            echo "::endgroup::"
          done

          echo "built_packages=$BUILT_PACKAGES" >> $GITHUB_OUTPUT
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

          if [ -n "$VERSIONS" ]; then
            echo "has_releases=true" >> $GITHUB_OUTPUT
          else
            echo "has_releases=false" >> $GITHUB_OUTPUT
          fi

      - name: Push version bumps and tags
        if: steps.bump.outputs.has_releases == 'true'
        run: |
          git push origin main --follow-tags

      - name: Create GitHub Releases
        if: steps.bump.outputs.has_releases == 'true'
        run: |
          for entry in ${{ steps.bump.outputs.versions }}; do
            provider=$(echo $entry | cut -d: -f1)
            version=$(echo $entry | cut -d: -f2)

            gh release create "${provider}-v${version}" \
              --title "pragmatiks-${provider}-provider v${version}" \
              --generate-notes \
              packages/${provider}/dist/* || echo "Release may already exist"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        if: steps.bump.outputs.has_releases == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/*/dist/
          skip-existing: true
