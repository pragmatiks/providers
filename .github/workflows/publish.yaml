name: Publish Providers

on:
  push:
    branches:
      - main

# Provider dependency chain (publish in this order):
# 1. gcp (no internal deps)
# 2. qdrant (no internal deps) - can be parallel with gcp
# 3. kubernetes (depends on gcp)
# 4. agno (depends on gcp, kubernetes)
#
# We publish each tier sequentially to ensure dependencies are available on PyPI.

jobs:
  detect-changes:
    if: "!startsWith(github.event.head_commit.message, 'bump:')"
    runs-on: ubuntu-latest
    outputs:
      gcp: ${{ steps.changes.outputs.gcp }}
      qdrant: ${{ steps.changes.outputs.qdrant }}
      kubernetes: ${{ steps.changes.outputs.kubernetes }}
      agno: ${{ steps.changes.outputs.agno }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed providers
        id: changes
        run: |
          # Get changed files since last provider tag or last commit
          LAST_TAG=$(git tag -l "*-v*" --sort=-version:refname | head -1 || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGED_FILES=$(git diff --name-only "$LAST_TAG"..HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git ls-files)
          fi

          # Check each provider individually
          HAS_CHANGES=false

          for provider in gcp qdrant kubernetes agno; do
            if echo "$CHANGED_FILES" | grep -q "^packages/$provider/"; then
              echo "$provider=true" >> $GITHUB_OUTPUT
              echo "Changed: $provider"
              HAS_CHANGES=true
            else
              echo "$provider=false" >> $GITHUB_OUTPUT
            fi
          done

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # Tier 1: Base providers with no internal dependencies
  publish-tier-1:
    needs: detect-changes
    if: needs.detect-changes.outputs.gcp == 'true' || needs.detect-changes.outputs.qdrant == 'true'
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write
    outputs:
      gcp_version: ${{ steps.bump.outputs.gcp_version }}
      qdrant_version: ${{ steps.bump.outputs.qdrant_version }}

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.x"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install commitizen
        run: uv tool install commitizen

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump and build tier 1 providers
        id: bump
        env:
          CHANGED_GCP: ${{ needs.detect-changes.outputs.gcp }}
          CHANGED_QDRANT: ${{ needs.detect-changes.outputs.qdrant }}
        run: |
          process_provider() {
            local provider=$1
            echo "::group::Processing $provider"
            cd packages/$provider

            if cz bump --yes --changelog 2>&1 | tee bump_output.txt; then
              VERSION=$(cz version --project)
              echo "Bumped $provider to v$VERSION"
              echo "${provider}_version=$VERSION" >> $GITHUB_OUTPUT
              uv build --package pragmatiks-${provider}-provider --out-dir ../../dist
            else
              if grep -qE "No commits found|is not a bump" bump_output.txt; then
                echo "No bump needed for $provider"
              else
                cat bump_output.txt
                exit 1
              fi
            fi

            cd ../..
            echo "::endgroup::"
          }

          if [ "$CHANGED_GCP" = "true" ]; then
            process_provider gcp
          fi

          if [ "$CHANGED_QDRANT" = "true" ]; then
            process_provider qdrant
          fi

      - name: Push version bumps and tags
        run: git push origin main --follow-tags || echo "Nothing to push"

      - name: Create GitHub Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GCP_VERSION: ${{ steps.bump.outputs.gcp_version }}
          QDRANT_VERSION: ${{ steps.bump.outputs.qdrant_version }}
        run: |
          if [ -n "$GCP_VERSION" ]; then
            gh release create "gcp-v${GCP_VERSION}" \
              --title "pragmatiks-gcp-provider v${GCP_VERSION}" \
              --generate-notes \
              dist/pragmatiks_gcp_provider-${GCP_VERSION}* || echo "Release may already exist"
          fi

          if [ -n "$QDRANT_VERSION" ]; then
            gh release create "qdrant-v${QDRANT_VERSION}" \
              --title "pragmatiks-qdrant-provider v${QDRANT_VERSION}" \
              --generate-notes \
              dist/pragmatiks_qdrant_provider-${QDRANT_VERSION}* || echo "Release may already exist"
          fi

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true

      - name: Publish to pragma store
        env:
          PRAGMA_API_URL: https://api.pragmatiks.io
          PRAGMA_CLERK_TOKEN: ${{ secrets.PRAGMA_CI_CLERK_TOKEN }}
        run: |
          if [ -n "${{ steps.bump.outputs.gcp_version }}" ]; then
            echo "Publishing gcp v${{ steps.bump.outputs.gcp_version }} to pragma store..."
            cd packages/gcp
            uv run pragma providers publish --version ${{ steps.bump.outputs.gcp_version }}
            cd ../..
          fi

          if [ -n "${{ steps.bump.outputs.qdrant_version }}" ]; then
            echo "Publishing qdrant v${{ steps.bump.outputs.qdrant_version }} to pragma store..."
            cd packages/qdrant
            uv run pragma providers publish --version ${{ steps.bump.outputs.qdrant_version }}
            cd ../..
          fi

  # Tier 2: Providers that depend on tier 1
  publish-tier-2:
    needs: [detect-changes, publish-tier-1]
    if: |
      always() &&
      needs.detect-changes.outputs.kubernetes == 'true' &&
      (needs.publish-tier-1.result == 'success' || needs.publish-tier-1.result == 'skipped')
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write
    outputs:
      kubernetes_version: ${{ steps.bump.outputs.kubernetes_version }}

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ steps.app-token.outputs.token }}

      - name: Pull latest changes
        run: git pull origin main

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.x"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install commitizen
        run: uv tool install commitizen

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Wait for PyPI availability
        if: needs.publish-tier-1.outputs.gcp_version != ''
        run: |
          PACKAGE="pragmatiks-gcp-provider"
          VERSION="${{ needs.publish-tier-1.outputs.gcp_version }}"
          echo "Waiting for $PACKAGE v$VERSION on PyPI..."
          for i in {1..30}; do
            if curl -sf "https://pypi.org/pypi/$PACKAGE/$VERSION/json" > /dev/null; then
              echo "Package available on PyPI"
              exit 0
            fi
            echo "Attempt $i: Package not yet available, waiting 10s..."
            sleep 10
          done
          echo "Timed out waiting for package on PyPI"
          exit 1

      - name: Bump and build kubernetes
        id: bump
        run: |
          echo "::group::Processing kubernetes"
          cd packages/kubernetes

          if cz bump --yes --changelog 2>&1 | tee bump_output.txt; then
            VERSION=$(cz version --project)
            echo "Bumped kubernetes to v$VERSION"
            echo "kubernetes_version=$VERSION" >> $GITHUB_OUTPUT

            uv build --package pragmatiks-kubernetes-provider --out-dir ../../dist
          else
            if grep -qE "No commits found|is not a bump" bump_output.txt; then
              echo "No bump needed for kubernetes"
            else
              cat bump_output.txt
              exit 1
            fi
          fi

          cd ../..
          echo "::endgroup::"

      - name: Push version bumps and tags
        run: git push origin main --follow-tags || echo "Nothing to push"

      - name: Create GitHub Release
        if: steps.bump.outputs.kubernetes_version != ''
        run: |
          VERSION="${{ steps.bump.outputs.kubernetes_version }}"
          gh release create "kubernetes-v${VERSION}" \
            --title "pragmatiks-kubernetes-provider v${VERSION}" \
            --generate-notes \
            dist/pragmatiks_kubernetes_provider-${VERSION}* || echo "Release may already exist"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        if: steps.bump.outputs.kubernetes_version != ''
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true

      - name: Publish to pragma store
        if: steps.bump.outputs.kubernetes_version != ''
        env:
          PRAGMA_API_URL: https://api.pragmatiks.io
          PRAGMA_CLERK_TOKEN: ${{ secrets.PRAGMA_CI_CLERK_TOKEN }}
        run: |
          echo "Publishing kubernetes v${{ steps.bump.outputs.kubernetes_version }} to pragma store..."
          cd packages/kubernetes
          uv run pragma providers publish --version ${{ steps.bump.outputs.kubernetes_version }}

  # Tier 3: Providers that depend on tier 2
  publish-tier-3:
    needs: [detect-changes, publish-tier-1, publish-tier-2]
    if: |
      always() &&
      needs.detect-changes.outputs.agno == 'true' &&
      (needs.publish-tier-1.result == 'success' || needs.publish-tier-1.result == 'skipped') &&
      (needs.publish-tier-2.result == 'success' || needs.publish-tier-2.result == 'skipped')
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ steps.app-token.outputs.token }}

      - name: Pull latest changes
        run: git pull origin main

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.x"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install commitizen
        run: uv tool install commitizen

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Wait for PyPI availability
        run: |
          wait_for_package() {
            local package=$1
            local version=$2
            echo "Waiting for $package v$version on PyPI..."
            for i in {1..30}; do
              if curl -sf "https://pypi.org/pypi/$package/$version/json" > /dev/null; then
                echo "Package available on PyPI"
                return 0
              fi
              echo "Attempt $i: Package not yet available, waiting 10s..."
              sleep 10
            done
            echo "Timed out waiting for $package v$version on PyPI"
            return 1
          }

          # Wait for kubernetes if it was just published
          if [ -n "${{ needs.publish-tier-2.outputs.kubernetes_version }}" ]; then
            wait_for_package pragmatiks-kubernetes-provider "${{ needs.publish-tier-2.outputs.kubernetes_version }}"
          fi

          # Wait for gcp if it was just published
          if [ -n "${{ needs.publish-tier-1.outputs.gcp_version }}" ]; then
            wait_for_package pragmatiks-gcp-provider "${{ needs.publish-tier-1.outputs.gcp_version }}"
          fi

      - name: Bump and build agno
        id: bump
        run: |
          echo "::group::Processing agno"
          cd packages/agno

          if cz bump --yes --changelog 2>&1 | tee bump_output.txt; then
            VERSION=$(cz version --project)
            echo "Bumped agno to v$VERSION"
            echo "agno_version=$VERSION" >> $GITHUB_OUTPUT

            uv build --package pragmatiks-agno-provider --out-dir ../../dist
          else
            if grep -qE "No commits found|is not a bump" bump_output.txt; then
              echo "No bump needed for agno"
            else
              cat bump_output.txt
              exit 1
            fi
          fi

          cd ../..
          echo "::endgroup::"

      - name: Push version bumps and tags
        run: git push origin main --follow-tags || echo "Nothing to push"

      - name: Create GitHub Release
        if: steps.bump.outputs.agno_version != ''
        run: |
          VERSION="${{ steps.bump.outputs.agno_version }}"
          gh release create "agno-v${VERSION}" \
            --title "pragmatiks-agno-provider v${VERSION}" \
            --generate-notes \
            dist/pragmatiks_agno_provider-${VERSION}* || echo "Release may already exist"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        if: steps.bump.outputs.agno_version != ''
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true

      - name: Publish to pragma store
        if: steps.bump.outputs.agno_version != ''
        env:
          PRAGMA_API_URL: https://api.pragmatiks.io
          PRAGMA_CLERK_TOKEN: ${{ secrets.PRAGMA_CI_CLERK_TOKEN }}
        run: |
          echo "Publishing agno v${{ steps.bump.outputs.agno_version }} to pragma store..."
          cd packages/agno
          uv run pragma providers publish --version ${{ steps.bump.outputs.agno_version }}
